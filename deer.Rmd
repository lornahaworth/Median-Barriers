---
title: "Practicing the model deer"
author: Lorna Haworth
output: 
---
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

BRAINSTORMING NOTES
-data frame has response variable (roadkill) and possible predictors (NCLD, NHD, building)
-no empty values in rows

deer first, then animals in order of size (large-small)
maybe mtn lion next
sin wave on residual chart ?? why that shape

```{r load libraries} 
knitr::opts_knit$set(root.dir = "C:/R_studio/Research/Median-Barriers")
getwd()

library(tidyverse)
library(conflicted)
library(lmtest)     # for lrtest()
library(bbmle)      # for ICtab()
library(glmmTMB)    #to run simulation
library(DHARMa)     #to run simulation
library(stringr)
install.packages("MASS")
library(MASS) #for glm.nb

conflict_prefer("select", "dplyr")
conflict_prefer("filter", "dplyr")
conflict_prefer("summarize", "dplyr")

```

```{r read in data}

#District 2 random points
D2_random_sites <- read.csv("d2_random_sites_HPMS.csv")

#District 2 mule deer
D2_deer_hits <- read.csv("d2_deer_hits_HPMS.csv")

```


Make the data frames look better by only using necessary data
```{r make new data frames with simplified information from csv }

D2_random <- subset(D2_random_sites, select=c(#cid,
                                               MedianType,
                                               LANE_WIDTH,
                                               MEDIAN_TYP,
                                               MEDIAN_WID))
                                              # SecondaryAttribute, 
                                              # MedianWidth, 
                                              # RoadsideBarrier))

D2_deer <- subset(D2_deer_hits, select = c(animal, 
                                           condition, 
                                           MedianType,
                                           LANE_WIDTH,
                                           MEDIAN_TYP,
                                           MEDIAN_WID))

#add columns to random points dataframe for to distinguish random and animal condition
D2_random$animal<-"random" 
D2_random$condition <- "none"
```


```{r organize and group data}

#make combined data frame 

median_ug <- rbind(D2_random, D2_deer) #use in binomial model

median_deer <- median_ug %>%  #use in poisson
  group_by(MedianType, condition) %>%
  summarize(count=n(), .groups = "drop")

#keep only one median type in structure column, new data frame with single classes
median_deer <- median_deer %>%
  as.data.frame() %>%
  mutate(MedianType = case_when(
    str_detect(MedianType, "thrie beam") ~ "thrie beam", # If "thrie beam" is anywhere in the string, change to "thrie beam"
    str_detect(MedianType, "concrete") ~ "concrete",
    str_detect(MedianType, "cable") ~ "cable",
    str_detect(MedianType, "gravel") & str_detect(MedianType, "vegetative") ~ "vegetative", # If both "gravel" and "vegetative" are present, change to "vegetative"
    TRUE ~ MedianType # Keep other values as they are
  ))

#Create binary indicator for structures
library(stringr)
median_deer$structure <- 0 # Create structure column and assign it a default value of 0
median_deer <- median_deer %>%
  mutate(structure = case_when(
    str_detect(MedianType, "thrie beam") ~ 1, # If MedianType contains "thrie beam", change structure to 1
    str_detect(MedianType, "concrete") ~ 1, # If MedianType contains "concrete", change structure to 1
    str_detect(MedianType, "cable") ~ 1, # If MedianType contains "cable", change structure to 1
    TRUE ~ structure # Keep other values as they are
  ))

histogram(subset(median_deer, count < 500)$count)
#negative binomial distribution


```

Should I use means parameterization in the model? Is roadkill categorical data?
```{r OLD glm model with poisson distribution}
m1_deer <- glm(count ~ 1,
               data = median_deer,
               family = poisson(link="log"))

m2_D2_deer <-glm(count ~ MedianType + condition,
                     data = median_deer,
                     family = poisson(link = "log"))
lrtest(m1_deer, m2_D2_deer) #m2 is better than the null



```
```{r glm model with neg binomial distribution}
#model with neg binom
m3_D2_deer <- glm.nb(count ~ MedianType + condition,
                     data = median_deer)

#null
m4_D2_deer <- glm.nb(count ~ 1,
                     data = median_deer)

lrtest(m4_D2_deer, m3_D2_deer)
```

```{r OLD poisson simulated points}

#with model 1 deer (poisson)
simulation_output_2 <- simulateResiduals(fittedModel = m2_D2_deer)
plot(simulation_output_2)
testUniformity(simulation_output_2) #why the sin wave shape? does that indicate something with the data?

#null of deer just to see results
simulation_output_0 <- simulateResiduals(fittedModel = m1_deer)
plot(simulation_output_0)
testUniformity(simulation_output_0)
```


want to see a straight line of triangles along red line with the least amount of predictors in the model. if the triangles are horizontal the model is over estimating the response, if the triangles are vertical the model is under estimating the response.  
```{r test model against simulated points}

#neg binom model
simulation_output_3 <- simulateResiduals(fittedModel = m3_D2_deer)
plot(simulation_output_3)
testUniformity(simulation_output_3)

#neg binom null
simulation_output_4 <- simulateResiduals(fittedModel = m4_D2_deer)
plot(simulation_output_4)
testUniformity(simulation_output_4)

#model 3 is better than the null, that's good

```


